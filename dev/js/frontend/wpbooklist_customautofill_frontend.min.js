/**
 * JavaScript Admin Functions - wpbooklist-customautofill-frontend.min.js
 *
 * @author   Jake Evans
 * @category JavaScript
 * @package  Includes/Assets/Js
 * @version  6.0.0
 */

// All functions wrapped in jQuery(document ).ready()...
jQuery( document ).ready( function( $ ) {
	'use strict';

	/* BEGINNING SECTION TO CALL ALL FUNCTIONS IN FILE... */

	// Function to insert button that allows user to auto-fill based on ISBN
	wpbooklistCustomAutofillInsertButton();

	// Function to enable the insert button that allows user to auto-fill based on ISBN, once an ISBN is provided.
	wpbooklistCustomAutofillEnableInsertButton();

	// Function to grab book info based on provided isbn.
	wpbooklistCustomAutofillGetBookData();

	/* ENDING SECTION TO CALL ALL FUNCTIONS IN FILE... */

	// Function to insert button that allows user to auto-fill based on ISBN
	function wpbooklistCustomAutofillInsertButton(){

		var buttonHtml = '<div id="wpbooklist-customautofill-html-insertion-wrapper"><input type="submit" value="Search for Book" id="wpbooklist-customautofill-button-id" class="wcv-button wpbooklist-customautofill-button"/></div>';

		if ( -1 < window.location.href.indexOf( '/hoot-vendor-dashboard/product/simple/edit/' ) ) {
			$( '.control' ).first().append( buttonHtml );
		}
	}

	// Function to enable the insert button that allows user to auto-fill based on ISBN, once an ISBN is provided.
	function wpbooklistCustomAutofillEnableInsertButton(){

		if ( -1 < window.location.href.indexOf( '/hoot-vendor-dashboard/product/simple/edit/' ) ) {

			// On keyup...
			$( '#wcv_custom_product_isbn' ).on( 'keyup change paste drop', function( event ) {

				var _this = this;

				setTimeout(function() {

					// Get current input value.
					var currentVal = $( _this ).val();

					// If there are dashes in input, remove them.
					if ( -1 < currentVal.indexOf( '-' ) ) {
						$( _this ).val( currentVal.replace( /-/g, '' ) );
					}

					// If the input is at least 10 characters...
					if ( 10 <= currentVal.length ) {

						$( '#wpbooklist-customautofill-button-id' ).animate({
							'opacity': '1'
						}, {
							queue: false,
							duration: 100,
							complete: function() {
								$( this ).css({'pointer-events':'all'});
							}
						});

					} else {

						$( '#wpbooklist-customautofill-button-id' ).animate({
							'opacity': '0.3'
						}, {
							queue: false,
							duration: 100,
							complete: function() {
								$( this ).css({'pointer-events':'none'});
							}
						});
					}
				}, 0); //this timeout is necessary to get the value
			});
		}
	}


	// Function to grab book info based on provided isbn
	function wpbooklistCustomAutofillGetBookData(){

		var isbn = '';
		var data = [];
		var request = '';
		var description = '';
		var doc = '';
		var thumbnailpath = ''
		var imgtitle = ''
		var responsehtml = '';
		var boxShadow = 'rgb(120, 170, 58) 0px 0px 1px 2px';

		if ( -1 < window.location.href.indexOf( '/hoot-vendor-dashboard/product/simple/edit/' ) ) {

			$( document ).on( 'click', '#wpbooklist-customautofill-button-id', function( event ) {


				// Reset Everything!
				$( '#post_title' ).val( '' );
				$( '#post_title' ).css({'box-shadow': 'none'});
				$( '#wcv_custom_product_author' ).val( '' );
				$( '#wcv_custom_product_author' ).css({'box-shadow': 'none'});
				$( '#wcv_custom_product_publisher' ).val( '' );
				$( '#wcv_custom_product_publisher' ).css({'box-shadow': 'none'});
				$( '#wcv_custom_product_edition' ).val( '' );
				$( '#wcv_custom_product_edition' ).css({'box-shadow': 'none'});
				$( '#wcv_custom_product_subject' ).val( '' );
				$( '#wcv_custom_product_subject' ).css({'box-shadow': 'none'});
				$( '#post_content' ).val( '' );
				$( '#post_content' ).css({'box-shadow': 'none'});
				$( '#_regular_price' ).val( '' );
				$( '#_regular_price' ).css({'box-shadow': 'none'});
				$( 'label[for="_regular_price"]' ).text( 'Regular Price ($)' );

				$( '.wcv-featuredimg' ).empty();
				
				$( '#_featured_image_id' ).val( '' );

				$( '.wpbooklist-customautofill-response' ).animate({
					'opacity': '0'
				}, {
					queue: false,
					duration: 500,
					complete: function() {
						$( this ).remove();
					}
				});

				$( '.pageloader, .wr-loader-3' ).css({'display': 'block'});

				isbn = $( '#wcv_custom_product_isbn' ).val();
				isbn = isbn.replace( / /g, '' );

				data = {
					'action': 'wpbooklist_customautofill_get_book_action',
					'isbn': isbn,
					'security': wpbooklistCustomAutofillPhpVariables.adminnonce1
				};


				request = $.ajax({
					url: ajaxurl,
					type: 'POST',
					data: data,
					timeout: 0,
					success: function( response ) {

						response = JSON.parse( response );

						console.log(response);

						if( 0 !== response) {


							if ( '' !== response.title && null !== response.title && undefined !== response.title ) {
								$( '#post_title' ).val( response.title );
								$( '#post_title' ).css({'box-shadow': boxShadow})
							}

							if ( '' !== response.author && null !== response.author && undefined !== response.author ) {
								$( '#wcv_custom_product_author' ).val( response.author );
								$( '#wcv_custom_product_author' ).css({'box-shadow': boxShadow})
							}

							if ( '' !== response.publisher && null !== response.publisher && undefined !== response.publisher ) {
								$( '#wcv_custom_product_publisher' ).val( response.publisher );
								$( '#wcv_custom_product_publisher' ).css({'box-shadow': boxShadow})
							}

							if ( '' !== response.edition && null !== response.edition  && undefined !== response.edition  ) {
								$( '#wcv_custom_product_edition' ).val( response.title );
								$( '#wcv_custom_product_edition' ).css({'box-shadow': boxShadow})
							}

							if ( '' !== response.category && null !== response.category  && undefined !== response.category  ) {
								$( '#wcv_custom_product_subject' ).val( response.title );
								$( '#wcv_custom_product_subject' ).css({'box-shadow': boxShadow})
							}

							if ( '' !== response.lowestusedprice && null !== response.lowestusedprice  && undefined !== response.lowestusedprice  ) {
								$( '#_regular_price' ).val( response.lowestusedprice.replace( '$', '' ) );
								$( 'label[for="_regular_price"]' ).html( $( 'label[for="_regular_price"]' ).text() + ' <span class="wpbooklist-customautofill-response" id="wpbooklist-customautofill-suggested-price-response">Suggested Price is ' + response.lowestusedprice.replace( '$', '' ) + '</span>');
								$( '#_regular_price' ).css({'box-shadow': boxShadow});

							}

							if ( '' !== response.description && null !== response.description  && undefined !== response.description  ) {
							
								// Strip all HTML from Description and replace double spaces.
		 						doc = new DOMParser().parseFromString( response.description, 'text/html');
		   						description = doc.body.textContent || "";
		   						description = description.replace( /  /g, ' ' );

		   						$( '#post_content' ).val( description );
		   						$( '#post_content' ).css({'box-shadow': boxShadow});

	   						}

	   						thumbnailpath = response.image_attach_data.file.substring( 0, response.image_attach_data.file.lastIndexOf(".") );
	   						imgtitle = response.image_attach_data.file.substring( response.image_attach_data.file.lastIndexOf(".") + 1 );

	   						$( '.wcv-featuredimg' ).html( '<img src="http://hootbookrevival.com/wp-content/uploads/'+thumbnailpath+'-150x150.jpg" alt="" title="'+imgtitle+'" style="max-width: 100%;">' )
							
							$( '#_featured_image_id' ).val( response.image_attachment_id );


							responsehtml = '<p class="wpbooklist-customautofill-response" id="wpbooklist-customautofill-response-success"><span id="wpbooklist-customautofill-response-success-span">Success!</span> Review the Book Information below for accuracy.<br/>Fields highlighted in Green have been auto-filled.</p>';
							$( '#wpbooklist-customautofill-html-insertion-wrapper' ).append( responsehtml );

						} else {

							responsehtml = '<p class="wpbooklist-customautofill-response" id="wpbooklist-customautofill-response-fail"><span id="wpbooklist-customautofill-response-fail-span">Uh-Oh!</span> We couldn\'t retrieve information for this title.<br/>Please enter the information for this title manually or try again.</p>';
							$( '#wpbooklist-customautofill-html-insertion-wrapper' ).append( responsehtml );

						}

						$( '.pageloader, .wr-loader-3' ).css({'display': 'none'});
						
					},
					error: function( jqXHR, textStatus, errorThrown ) {
						
						console.log( errorThrown );
						console.log( textStatus );
						console.log( jqXHR );
					}
				});

				event.preventDefault ? event.preventDefault() : event.returnValue = false;

			});

		}
	}





});
